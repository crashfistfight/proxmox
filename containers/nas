#! /usr/bin/env bash

vars_() {
  timezone='Europe/Berlin'
  user='nas'
  syncthing_gui_address='0.0.0.0:8384'
  password_samba='password'
}

install_() {
  dnf update
  dnf install --assumeyes firewalld dnf-automatic samba syncthing podman

  useradd -m "$user"

  sed --in-place "s@^apply_updates = .*@apply_updates = yes@" /etc/dnf/automatic.conf

  tee /etc/sysctl.d/40-max-user-watches.conf > /dev/null <<EOF
fs.inotify.max_user_watches=524288
EOF

  timedatectl set-timezone "$timezone"

# samba
  (echo "$password_samba"; echo "$password_samba") | smbpasswd -a -s "$user" 

  tee /etc/samba/smb.conf /dev/null <<EOF
[global]
        workgroup = SAMBA
        security = user

        passdb backend = tdbsam

        printing = cups
        printcap name = cups
        load printers = yes
        cups options = raw

        # Install samba-usershares package for support
        include = /etc/samba/usershares.conf

[Pictures]
        comment = Pictures
        path = /home/${user}/Pictures
        writeable = yes
        browseable = yes
        public = yes
        create mask = 0644
        directory mask = 0755
        write list = user
EOF

# syncthing
  mkdir /etc/systemd/system/syncthing@.service.d/

  tee /etc/systemd/system/syncthing@.service.d/override.conf /dev/null <<EOF
[Service]
ExecStart=
ExecStart=/usr/bin/syncthing serve --no-browser --no-restart --logflags=0 --gui-address=${syncthing_gui_address}
EOF

# spis
  mkdir /home/"$user"/container/spis
  chown -R "$user":"$user" /home/"$user"/container

  tee /etc/systemd/system/container-spis.service<<EOF

# container-spis.service
# autogenerated by Podman 4.6.1
# Sun Aug 20 12:01:11 UTC 2023

[Unit]
Description=Podman container-spis.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStart=/usr/bin/podman run \
	--cidfile=%t/%n.ctr-id \
	--cgroups=no-conmon \
	--rm \
	--sdnotify=conmon \
	--replace \
	-d \
	--name spis \
	-p 8080:8080 \
	-v /home/${user}/Pictures:/var/lib/spis/media:ro \
	-v /home/${user}/container/spis/:/var/lib/spis/data ghcr.io/gbbirkisson/spis:latest
ExecStop=/usr/bin/podman stop \
	--ignore -t 10 \
	--cidfile=%t/%n.ctr-id
ExecStopPost=/usr/bin/podman rm \
	-f \
	--ignore -t 10 \
	--cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all

[Install]
WantedBy=default.target
EOF

#

  systemctl daemon-reload
  systemctl enable --now dnf-automatic.timer smb.service firewalld.service container-spis.service



  firewall-cmd --add-service={samba,syncthing,syncthing-gui} --permanent --quiet
  firewall-cmd --add-port=8080/tcp --permanent --quiet
  firewall-cmd --reload --quiet
}

vars_
install_